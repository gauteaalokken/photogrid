<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fotogrid Pro - Oppdatert</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  
  <style>
    /* --- CSS STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
    .app-container { height: 100vh; background-color: #e5e7eb; display: flex; }
    
    /* Sidebar */
    .sidebar { width: 340px; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; z-index: 30; flex-shrink: 0; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
    .sidebar-header h1 { font-size: 24px; font-weight: 600; color: #111827; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .sidebar-footer { padding: 20px; border-top: 1px solid #e5e7eb; background: #f9fafb; }

    /* Controls */
    .control-group { display: flex; flex-direction: column; gap: 8px; }
    .control-group label { font-size: 13px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Buttons */
    button { cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .btn-primary { width: 100%; padding: 10px; background-color: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:hover { background-color: #1d4ed8; }
    
    .btn-secondary { width: 100%; padding: 8px; background-color: white; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-secondary:hover { background-color: #f3f4f6; border-color: #9ca3af; }
    
    .btn-danger { background-color: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
    .btn-danger:hover { background-color: #fef2f2; border-color: #dc2626; }
    
    .btn-group { display: flex; gap: 8px; }
    .btn-group button { flex: 1; }
    
    /* Canvas Area */
    .main-canvas { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; background: #e5e7eb; }
    .canvas-wrapper { 
      flex: 1; display: flex; align-items: center; padding: 40px; gap: 40px; 
      overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth;
    }

    /* Page styling */
    .page-wrapper { display: flex; flex-direction: column; gap: 10px; transition: transform 0.3s; }
    .page-header { display: flex; justify-content: space-between; align-items: center; color: #6b7280; font-size: 12px; font-weight: 600; padding: 0 4px; }
    
    .page-container {
      background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: relative; overflow: hidden; transition: all 0.3s ease;
    }
    .page-container:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    
    /* Photo Grid inside Page */
    .photo-grid {
      display: grid; width: 100%; height: 100%;
    }
    .photo-cell {
      background: #f3f4f6; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .photo-cell img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .photo-cell:hover .remove-photo { opacity: 1; }
    
    .remove-photo {
      position: absolute; top: 5px; right: 5px; background: rgba(220, 38, 38, 0.9); color: white;
      width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 12px; border: none;
    }

    /* Inputs */
    input[type="range"] { width: 100%; accent-color: #2563eb; }
    select, input[type="text"], input[type="number"] { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; }

    /* Delete Page Button */
    .delete-page-btn {
        cursor: pointer; color: #ef4444; background: none; border: none; font-size: 16px;
        opacity: 0.5; transition: opacity 0.2s;
    }
    .delete-page-btn:hover { opacity: 1; transform: scale(1.1); }

    /* Modal / Overlay */
    .loading-overlay {
        position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100;
        display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .spinner {
        width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-weight:600; color:#374151">Jobber...</div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Fotogrid Pro</h1>
            <p style="color:#6b7280; font-size:14px;">Smart sideoppsett</p>
        </div>

        <div class="sidebar-content">
            <div class="control-group">
                <label>Bilder & Angre</label>
                <div class="btn-group">
                    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                        + Legg til bilder
                    </button>
                    <button class="btn-secondary" onclick="app.undo()" title="Angre siste handling">
                        Angre
                    </button>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="app.handleFiles(this.files)">
                <div style="font-size:12px; color:#6b7280; margin-top:4px;">
                    <span id="photoCount">0</span> bilder totalt
                </div>
            </div>

            <div class="control-group">
                <label>Sider</label>
                <div class="btn-group">
                    <button class="btn-secondary" onclick="app.addEmptyPage()" title="Setter inn ny side etter gjeldende side">
                        + Ny side her
                    </button>
                    <button class="btn-secondary" onclick="app.autoFlow()" title="Fyller opp tomrom">
                        Autoflyt
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label>Bilder per side: <span id="gridSizeVal">4</span></label>
                <input type="range" min="1" max="16" value="4" oninput="app.updateSettings('photosPerPage', this.value)">
            </div>

            <div class="control-group">
                <label>Marg: <span id="marginVal">2</span>mm</label>
                <input type="range" min="0" max="20" step="0.5" value="2" oninput="app.updateSettings('margin', this.value)">
            </div>

            <div class="control-group">
                <label>Mellomrom (Gap): <span id="gapVal">2</span>mm</label>
                <input type="range" min="0" max="20" step="0.5" value="2" oninput="app.updateSettings('gap', this.value)">
            </div>

            <div class="control-group">
                <label>Papir & Retning</label>
                <select onchange="app.updateSettings('paperSize', this.value)">
                    <option value="A4">A4</option>
                    <option value="A3">A3</option>
                    <option value="10x15">10x15 cm</option>
                </select>
                <div class="btn-group" style="margin-top:8px;">
                    <button class="btn-secondary" onclick="app.updateSettings('orientation', 'portrait')">Portrett</button>
                    <button class="btn-secondary" onclick="app.updateSettings('orientation', 'landscape')">Landskap</button>
                </div>
            </div>
            
             <div class="control-group">
                <label>Bakgrunnsfarge</label>
                <input type="color" value="#ffffff" style="width:100%; height:30px; cursor:pointer;" oninput="app.updateSettings('bgColor', this.value)">
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="btn-primary" onclick="app.exportAll()" style="background-color:#111827;">
                Last ned ZIP (Høy kvalitet)
            </button>
        </div>
    </div>

    <div class="main-canvas">
        <div id="canvasWrapper" class="canvas-wrapper">
            </div>
    </div>
</div>

<script>
/**
 * FOTOGRID ENGINE V2
 * Fullstendig omskrevet logikk for bedre sidehåndtering
 */

const app = {
    // State
    pages: [[]], // Array av arrays (sider med bilder)
    history: [], // For undo-funksjon
    settings: {
        photosPerPage: 4,
        margin: 2,
        gap: 2,
        paperSize: 'A4',
        orientation: 'portrait',
        bgColor: '#ffffff',
        dpi: 300
    },
    // Konstanter for papirstørrelser (i mm)
    paperSizes: {
        'A4': { w: 210, h: 297 },
        'A3': { w: 297, h: 420 },
        '10x15': { w: 102, h: 152 }
    },

    init() {
        this.render();
    },

    // --- State Management ---
    saveState() {
        // Lagre kopi av nåværende tilstand i historikken
        this.history.push(JSON.stringify(this.pages));
        if (this.history.length > 20) this.history.shift(); // Begrens historikk
    },

    undo() {
        if (this.history.length === 0) return alert("Ingenting å angre!");
        const previousState = this.history.pop();
        this.pages = JSON.parse(previousState);
        this.render();
    },

    // --- Kjernefunksjoner ---

    handleFiles(fileList) {
        this.saveState();
        Array.from(fileList).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.addPhotoToFirstAvailableSlot(e.target.result);
            };
            reader.readAsDataURL(file);
        });
    },

    addPhotoToFirstAvailableSlot(imgData) {
        // Finn første side med plass
        let targetPage = this.pages.find(p => p.length < this.settings.photosPerPage);
        
        if (targetPage) {
            targetPage.push({ src: imgData, id: Date.now() + Math.random() });
        } else {
            // Alle sider fulle, lag ny på slutten
            this.pages.push([{ src: imgData, id: Date.now() + Math.random() }]);
        }
        this.render();
        this.updateStats();
    },

    // *** DENNE FUNKSJONEN SØRGER FOR AT NY SIDE KOMMER RETT ETTER ***
    addEmptyPage() {
        this.saveState();
        
        // 1. Finn hvilken side brukeren ser på nå (basert på scroll)
        const wrapper = document.getElementById('canvasWrapper');
        const scrollCenter = wrapper.scrollLeft + (wrapper.clientWidth / 2);
        
        let activeIndex = 0;
        let minDiff = Infinity;
        
        // Gå gjennom alle side-elementene i DOM for å finne den i midten
        const pageElements = document.querySelectorAll('.page-wrapper');
        pageElements.forEach((el, index) => {
            const center = el.offsetLeft + (el.offsetWidth / 2);
            const diff = Math.abs(scrollCenter - center);
            if (diff < minDiff) {
                minDiff = diff;
                activeIndex = index;
            }
        });
        
        // 2. Sett inn ny side (tomt array) ETTER den aktive indeksen
        // splice(index, hvor_mange_slette, hva_legge_til)
        const newIndex = activeIndex + 1;
        this.pages.splice(newIndex, 0, []);
        
        // 3. Tegn opp på nytt
        this.render();
        
        // 4. Scroll til den nye siden
        setTimeout(() => {
            const newPageEl = document.querySelectorAll('.page-wrapper')[newIndex];
            if (newPageEl) newPageEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }, 100);
    },

    deletePage(index) {
        if (this.pages[index].length > 0) {
            if (!confirm(`Denne siden har ${this.pages[index].length} bilder. Er du sikker på at du vil slette den?`)) return;
        }
        this.saveState();
        this.pages.splice(index, 1);
        if (this.pages.length === 0) this.pages.push([]); // Alltid minst én side
        this.render();
    },

    removePhoto(pageIndex, photoIndex) {
        this.saveState();
        this.pages[pageIndex].splice(photoIndex, 1);
        this.render();
        this.updateStats();
    },

    autoFlow() {
        if(!confirm("Dette vil stokke om alle bildene for å fylle hull. Vil du fortsette?")) return;
        this.saveState();
        // Samle alle bilder i en stor haug
        const allPhotos = this.pages.flat();
        // Tøm sidene
        this.pages = [];
        // Fordel på nytt
        while(allPhotos.length > 0) {
            const chunk = allPhotos.splice(0, this.settings.photosPerPage);
            this.pages.push(chunk);
        }
        if(this.pages.length === 0) this.pages.push([]);
        this.render();
    },

    updateSettings(key, value) {
        this.settings[key] = value;
        // Oppdater visuelle verdier i sidebar
        if(key === 'photosPerPage') document.getElementById('gridSizeVal').innerText = value;
        if(key === 'margin') document.getElementById('marginVal').innerText = value;
        if(key === 'gap') document.getElementById('gapVal').innerText = value;
        
        this.render();
    },

    updateStats() {
        const count = this.pages.reduce((acc, p) => acc + p.length, 0);
        document.getElementById('photoCount').innerText = count;
    },

    // --- Rendering (Tegner opp HTML) ---
    render() {
        const wrapper = document.getElementById('canvasWrapper');
        wrapper.innerHTML = ''; // Tøm container

        // Beregn størrelse basert på A4/A3 og retning
        let dim = this.paperSizes[this.settings.paperSize];
        if (!dim) dim = this.paperSizes['A4'];
        
        let width = dim.w;
        let height = dim.h;
        
        if (this.settings.orientation === 'landscape') {
            [width, height] = [height, width];
        }

        // CSS skalering for visning (konverter mm til px grovt)
        const scale = 1.5; // Zoom factor for skjerm
        const pxW = width * 3.78 * scale; // 1mm ≈ 3.78px
        const pxH = height * 3.78 * scale;

        this.pages.forEach((photos, pageIndex) => {
            // Wrapper for label + page
            const pageWrap = document.createElement('div');
            pageWrap.className = 'page-wrapper';
            
            // Header
            const header = document.createElement('div');
            header.className = 'page-header';
            header.innerHTML = `
                <span>Side ${pageIndex + 1}</span>
                <button class="delete-page-btn" onclick="app.deletePage(${pageIndex})" title="Slett side">×</button>
            `;
            pageWrap.appendChild(header);

            // Selve siden
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-container';
            pageDiv.style.width = `${pxW}px`;
            pageDiv.style.height = `${pxH}px`;
            pageDiv.style.backgroundColor = this.settings.bgColor;
            pageDiv.style.padding = `${this.settings.margin * 3.78 * scale}px`;

            // Grid Layout kalkulering
            const count = parseInt(this.settings.photosPerPage);
            // En enkel algoritme for rader/kolonner (beste fit)
            const cols = Math.ceil(Math.sqrt(count));
            const rows = Math.ceil(count / cols);
            
            const grid = document.createElement('div');
            grid.className = 'photo-grid';
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            grid.style.gap = `${this.settings.gap * 3.78 * scale}px`;

            // Fyll rutenettet
            for (let i = 0; i < count; i++) {
                const cell = document.createElement('div');
                cell.className = 'photo-cell';
                
                if (photos[i]) {
                    const img = document.createElement('img');
                    img.src = photos[i].src;
                    cell.appendChild(img);
                    
                    const rmBtn = document.createElement('button');
                    rmBtn.className = 'remove-photo';
                    rmBtn.innerHTML = '×';
                    rmBtn.onclick = () => app.removePhoto(pageIndex, i);
                    cell.appendChild(rmBtn);
                } else {
                    // Tom celle styling (valgfritt)
                    cell.style.background = 'transparent'; 
                    cell.style.border = '1px dashed #e5e7eb';
                }
                grid.appendChild(cell);
            }

            pageDiv.appendChild(grid);
            pageWrap.appendChild(pageDiv);
            wrapper.appendChild(pageWrap);
        });
    },

    // --- Export Logic (ZIP) ---
    async exportAll() {
        const overlay = document.getElementById('loadingOverlay');
        const status = document.getElementById('loadingText');
        overlay.style.display = 'flex';
        status.innerText = "Forbereder eksport...";

        try {
            const zip = new JSZip();
            const dpi = 300;
            const pxPerMm = dpi / 25.4;

            // Få dimensjoner
            let dim = this.paperSizes[this.settings.paperSize] || this.paperSizes['A4'];
            let pgW = (this.settings.orientation === 'portrait' ? dim.w : dim.h) * pxPerMm;
            let pgH = (this.settings.orientation === 'portrait' ? dim.h : dim.w) * pxPerMm;

            for (let i = 0; i < this.pages.length; i++) {
                if (this.pages[i].length === 0) continue; // Hopp over tomme sider
                
                status.innerText = `Genererer side ${i + 1} av ${this.pages.length}...`;
                
                // Vi tegner hver side på et midlertidig canvas
                const canvas = document.createElement('canvas');
                canvas.width = pgW;
                canvas.height = pgH;
                const ctx = canvas.getContext('2d');
                
                // Bakgrunn
                ctx.fillStyle = this.settings.bgColor;
                ctx.fillRect(0, 0, pgW, pgH);

                // Grid kalkulasjoner
                const count = parseInt(this.settings.photosPerPage);
                const cols = Math.ceil(Math.sqrt(count));
                const rows = Math.ceil(count / cols);
                
                const marginPx = this.settings.margin * pxPerMm;
                const gapPx = this.settings.gap * pxPerMm;
                
                // Område tilgjengelig for bilder
                const contentW = pgW - (marginPx * 2);
                const contentH = pgH - (marginPx * 2);
                
                const cellW = (contentW - (gapPx * (cols - 1))) / cols;
                const cellH = (contentH - (gapPx * (rows - 1))) / rows;

                // Tegn bilder
                const photos = this.pages[i];
                for (let j = 0; j < photos.length; j++) {
                    const r = Math.floor(j / cols);
                    const c = j % cols;
                    
                    const x = marginPx + (c * (cellW + gapPx));
                    const y = marginPx + (r * (cellH + gapPx));

                    const img = new Image();
                    img.src = photos[j].src;
                    await new Promise(r => img.onload = r); // Vent på last
                    
                    // "Object-fit: cover" logikk for canvas
                    const imgRatio = img.width / img.height;
                    const cellRatio = cellW / cellH;
                    let drawW, drawH, drawX, drawY;

                    if (imgRatio > cellRatio) {
                        drawH = cellH;
                        drawW = cellH * imgRatio;
                        drawY = y;
                        drawX = x - (drawW - cellW) / 2;
                    } else {
                        drawW = cellW;
                        drawH = cellW / imgRatio;
                        drawX = x;
                        drawY = y - (drawH - cellH) / 2;
                    }

                    ctx.save();
                    ctx.beginPath();
                    ctx.rect(x, y, cellW, cellH);
                    ctx.clip(); // Klipp til cellen
                    ctx.drawImage(img, drawX, drawY, drawW, drawH);
                    ctx.restore();
                }

                // Legg til i zip
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                zip.file(`Fotogrid-Side-${i+1}.jpg`, blob);
            }

            status.innerText = "Komprimerer ZIP...";
            const content = await zip.generateAsync({type:"blob"});
            
            // Last ned
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "fotogrid-eksport.zip";
            a.click();
            
        } catch (err) {
            alert("En feil oppstod: " + err.message);
            console.error(err);
        } finally {
            overlay.style.display = 'none';
        }
    }
};

// Start appen
app.init();
</script>
</body>
</html>
