<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photo Grid ‚Äî Exporter</title>
  <style>
    :root{
      --bg:#f7f8fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;--text:#111827;
    }
    [data-theme="dark"]{
      --bg:#0b1020;--card:#0f1724;--muted:#9ca3b3;--accent:#60a5fa;--text:#eef2ff;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
    .topbar{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card);border-bottom:1px solid rgba(0,0,0,0.04);position:sticky;top:0;z-index:20;}
    .brand{font-weight:700;font-size:16px}
    .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.06)}
    .container{display:flex;gap:24px;padding:20px;align-items:flex-start;max-width:1200px;margin:0 auto}
    .sidebar{width:320px;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    .section{margin-bottom:14px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="range"]{width:100%}
    input[type="number"],select,input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:transparent}
    .photo-count{font-size:13px;color:var(--muted);margin-top:6px}
    .main{flex:1;display:flex;flex-direction:column;gap:12px}
    .canvas-wrapper{display:flex;flex-direction:column;gap:16px;align-items:center}
    .canvas{background:var(--card);border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.06);overflow:hidden;position:relative}
    .dropzone{padding:60px 40px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted)}
    .grid-container{position:relative}
    .photo-cell{position:absolute;overflow:hidden;border-radius:6px;background:#eee}
    .photo-cell img{width:100%;height:100%;object-fit:cover;display:block}
    .remove-btn{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.6);color:white;border:none;padding:6px;border-radius:8px;cursor:pointer;z-index:5}
    .footer-actions{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    /* responsive: sidebar top on small screens */
    @media (max-width:900px){
      .container{flex-direction:column;padding:12px}
      .sidebar{width:100%;order:0}
      .main{order:1}
      .canvas{width:100%}
    }
    /* small mobile tuning */
    @media (max-width:420px){
      .dropzone{padding:40px 16px}
      .topbar{padding:10px}
      .brand{font-size:14px}
    }
    /* switch style */
    .switch{display:inline-flex;align-items:center;gap:8px}
    .toggle{width:44px;height:26px;background:#cbd5e1;border-radius:999px;position:relative;cursor:pointer}
    .toggle .knob{position:absolute;top:3px;left:3px;width:20px;height:20px;background:white;border-radius:50%;transition:all .18s}
    .toggle.on{background:var(--accent)}
    .toggle.on .knob{left:21px}
  </style>
</head>
<body data-theme="light">
  <div class="topbar">
    <div class="brand">Photo Grid</div>
    <div class="small">Create printable layouts ‚Äî export pages & download originals</div>

    <div class="controls">
      <div class="switch" title="Light / Dark">
        <div id="themeToggle" class="toggle" role="button" aria-pressed="false"><div class="knob"></div></div>
      </div>
      <input id="fileInput" type="file" accept="image/*" multiple style="display:none"/>
      <button class="btn" id="uploadBtn">Upload</button>
      <button class="btn ghost" id="downloadAllBtn" title="Download all original images as ZIP" disabled>Download All</button>
      <button class="btn" id="exportBtn" disabled>Export Pages</button>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <div class="section">
        <label>Photos</label>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="document.getElementById('fileInput').click()">Choose</button>
          <button class="btn ghost" onclick="clearAll()" id="clearBtn" style="display:none">Clear</button>
        </div>
        <div class="photo-count"><span id="photoCount">0</span> photos</div>
      </div>

      <div class="section">
        <label>Photos per page: <span id="photosPerPageValue">12</span></label>
        <input id="photosPerPage" type="range" min="1" max="36" value="12" oninput="syncPhotosPerPage(this.value)"/>
        <input id="photosPerPageInput" type="number" min="1" max="36" value="12" oninput="syncPhotosPerPage(this.value)" style="margin-top:6px"/>
      </div>

      <div class="section">
        <label>Paper Size</label>
        <select id="paperSize" onchange="renderGrid()">
          <option value="A4">A4 (210√ó297mm)</option>
          <option value="A3">A3 (297√ó420mm)</option>
          <option value="A2">A2 (420√ó594mm)</option>
          <option value="LETTER">Letter (8.5√ó11")</option>
        </select>
      </div>

      <div class="section">
        <label>Orientation</label>
        <div style="display:flex;gap:8px">
          <button class="btn" id="portraitBtn" onclick="setOrientation('portrait')">Portrait</button>
          <button class="btn ghost" id="landscapeBtn" onclick="setOrientation('landscape')">Landscape</button>
        </div>
      </div>

      <div class="section">
        <label>Margin (mm)</label>
        <input id="margin" type="number" min="0" max="50" value="10" onchange="renderGrid()" />
      </div>

      <div class="section">
        <label>Gap (mm)</label>
        <input id="gap" type="number" min="0" max="30" value="5" onchange="renderGrid()" />
      </div>

      <div class="section">
        <label>Background</label>
        <input id="bgColor" type="color" value="#ffffff" onchange="renderGrid()" />
      </div>

      <div class="section">
        <label>Export DPI</label>
        <select id="dpi">
          <option value="150">150 (draft)</option>
          <option value="300" selected>300 (standard)</option>
          <option value="600">600 (high)</option>
        </select>
      </div>

      <div class="section small">
        <div>Pages: <span id="pageCount">0</span></div>
      </div>
    </aside>

    <main class="main">
      <div id="canvasWrapper" class="canvas-wrapper">
        <div class="canvas" id="previewCanvas" style="width:820px;height:1160px;background:#fff">
          <div class="dropzone" id="dropzone">
            <div style="font-size:40px;opacity:.9">üìÅ</div>
            <div style="margin-top:12px;font-weight:600">Drop or upload images</div>
            <div class="small" style="margin-top:6px">Max images per page: 36 ¬∑ Mobile friendly</div>
          </div>
        </div>
      </div>
      <div class="footer-actions" style="justify-content:center">
        <div class="small">Tip: drag & drop images onto the preview area</div>
      </div>
    </main>
  </div>

  <!-- Load JSZip from CDN for ZIP downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const PAPER_SIZES = {
      A4:{width:210,height:297},
      A3:{width:297,height:420},
      A2:{width:420,height:594},
      LETTER:{width:216,height:279}
    };
    let photos = []; // {id, src (dataURL), name, width, height, aspectRatio}
    let orientation = 'portrait';

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const exportBtn = document.getElementById('exportBtn');
    const dropzone = document.getElementById('dropzone');

    uploadBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', (e)=>handleFiles(Array.from(e.target.files)));

    // Drag & drop
    const previewCanvas = document.getElementById('previewCanvas');
    previewCanvas.addEventListener('dragover', e=>{e.preventDefault(); previewCanvas.style.opacity=0.9});
    previewCanvas.addEventListener('dragleave', e=>{previewCanvas.style.opacity=1});
    previewCanvas.addEventListener('drop', e=>{e.preventDefault(); previewCanvas.style.opacity=1; handleFiles(Array.from(e.dataTransfer.files))});

    function handleFiles(files){
      const promises = files.filter(f=>f.type && f.type.startsWith('image/')).map(file=>new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = (ev)=>{
          const img = new Image();
          img.onload = ()=>{
            resolve({id:Date.now()+Math.random(), src:ev.target.result, name:file.name, width:img.width, height:img.height, aspectRatio: img.width/img.height});
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }));
      Promise.all(promises).then(newPhotos=>{
        newPhotos.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true, sensitivity:'base'}));
        photos.push(...newPhotos);
        updateUI();
      });
    }

    function updateUI(){
      document.getElementById('photoCount').textContent = photos.length;
      document.getElementById('clearBtn').style.display = photos.length? 'inline-block':'none';
      downloadAllBtn.disabled = photos.length===0;
      exportBtn.disabled = photos.length===0;
      renderGrid();
    }

    function clearAll(){ if(confirm('Clear all photos?')){ photos=[]; updateUI(); } }

    function syncPhotosPerPage(val){
      const v = Math.max(1, Math.min(36, Number(val)||1));
      document.getElementById('photosPerPage').value = v;
      document.getElementById('photosPerPageInput').value = v;
      document.getElementById('photosPerPageValue').textContent = v;
      renderGrid();
    }

    function setOrientation(o){
      orientation=o;
      document.getElementById('portraitBtn').classList.toggle('ghost', o!=='portrait');
      document.getElementById('landscapeBtn').classList.toggle('ghost', o!=='landscape');
      renderGrid();
    }

    function getPaperDimensions(){
      const sz = document.getElementById('paperSize').value;
      const size = PAPER_SIZES[sz];
      return orientation==='landscape' ? {width:size.height, height:size.width} : {width:size.width, height:size.height};
    }

    function calculateGrid(photosForPage, width, height, gap){
      // Simple responsive grid: try rows from 1..6 to find balanced layout
      if(photosForPage.length===0) return {cells:[]};
      const maxRows = Math.min(6, photosForPage.length);
      let best=null;
      for(let rows=1; rows<=maxRows; rows++){
        const cols = Math.ceil(photosForPage.length/rows);
        const cellW = (width - (cols-1)*gap)/cols;
        const cellH = (height - (rows-1)*gap)/rows;
        // measure mismatch to aspect ratios
        let score=0;
        for(let i=0;i<photosForPage.length;i++){
          const photo = photosForPage[i];
          const targetAspect = cellW/cellH;
          score += Math.abs(photo.aspectRatio - targetAspect);
        }
        if(!best || score<best.score) best={rows,cols,cellW,cellH,score};
      }
      // build cells
      const cells=[];
      for(let i=0;i<photosForPage.length;i++){
        const row = Math.floor(i/best.cols);
        const col = i%best.cols;
        cells.push({x: col*(best.cellW+gap), y: row*(best.cellH+gap), width:best.cellW, height:best.cellH});
      }
      return {cells};
    }

    function renderGrid(){
      const paper = getPaperDimensions();
      const availableWidth = Math.min(820, window.innerWidth - 120);
      const aspect = paper.width / paper.height;
      const displayHeight = Math.round(availableWidth / aspect);
      const wrapper = document.getElementById('canvasWrapper');
      wrapper.innerHTML='';

      const photosPerPage = Number(document.getElementById('photosPerPage').value)||12;
      const margin = Number(document.getElementById('margin').value)||10;
      const gap = Number(document.getElementById('gap').value)||5;
      const bg = document.getElementById('bgColor').value;

      const pages = Math.ceil(photos.length / photosPerPage) || 1;
      document.getElementById('pageCount').textContent = pages;

      if(photos.length===0){
        const canvas = document.createElement('div'); canvas.className='canvas'; canvas.style.width=availableWidth+'px'; canvas.style.height=displayHeight+'px'; canvas.style.background=bg;
        canvas.innerHTML = document.getElementById('dropzone').outerHTML;
        wrapper.appendChild(canvas);
        return;
      }

      for(let p=0;p<pages;p++){
        const start = p*photosPerPage; const end = Math.min(start+photosPerPage, photos.length);
        const pagePhotos = photos.slice(start,end);
        const canvas = document.createElement('div'); canvas.className='canvas'; canvas.style.width=availableWidth+'px'; canvas.style.height=displayHeight+'px'; canvas.style.background=bg;
        const gridEl = document.createElement('div'); gridEl.className='grid-container'; gridEl.style.left = '0'; gridEl.style.top='0'; gridEl.style.width='100%'; gridEl.style.height='100%';
        const padX = (margin / paper.width) * availableWidth;
        const padY = (margin / paper.height) * displayHeight;
        // compute available area inside margins
        const availW = availableWidth - 2*padX;
        const availH = displayHeight - 2*padY;
        const grid = calculateGrid(pagePhotos, availW, availH, (gap/paper.width)*availableWidth);
        pagePhotos.forEach((ph,i)=>{
          if(i>=grid.cells.length) return;
          const cell=grid.cells[i];
          const el = document.createElement('div'); el.className='photo-cell';
          el.style.left = (padX + cell.x) + 'px';
          el.style.top = (padY + cell.y) + 'px';
          el.style.width = cell.width + 'px';
          el.style.height = cell.height + 'px';
          const img = document.createElement('img'); img.src = ph.src; img.alt = ph.name;
          const btn = document.createElement('button'); btn.className='remove-btn'; btn.title='Remove photo'; btn.innerHTML='‚úï';
          btn.onclick = ()=>{ photos = photos.filter(x=>x.id!==ph.id); updateUI(); };
          el.appendChild(img); el.appendChild(btn); gridEl.appendChild(el);
        });
        const label = document.createElement('div'); label.style.cssText='position:absolute;right:10px;bottom:8px;font-size:13px;color:var(--muted);';
        label.textContent = `Page ${p+1} / ${pages}`;
        canvas.appendChild(gridEl); canvas.appendChild(label); wrapper.appendChild(canvas);
      }
    }

    // EXPORT: draw high-res pages in canvas and download as JPGs
    async function exportPages(){
      if(photos.length===0) return;
      const paper = getPaperDimensions();
      const dpi = Number(document.getElementById('dpi').value)||300;
      const mmToPx = dpi/25.4;
      const w = Math.round(paper.width*mmToPx);
      const h = Math.round(paper.height*mmToPx);
      const margin = Number(document.getElementById('margin').value)||10;
      const gap = Number(document.getElementById('gap').value)||5;
      const photosPerPage = Number(document.getElementById('photosPerPage').value)||12;
      const pages = [];
      for(let i=0;i<photos.length;i+=photosPerPage) pages.push(photos.slice(i,i+photosPerPage));
      const bg = document.getElementById('bgColor').value;
      for(let p=0;p<pages.length;p++){
        const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
        ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
        const pad = margin*mmToPx;
        const availW = w - 2*pad; const availH = h - 2*pad;
        const grid = calculateGrid(pages[p], availW, availH, gap*mmToPx);
        for(let i=0;i<pages[p].length && i<grid.cells.length;i++){
          const cell = grid.cells[i];
          const ph = pages[p][i];
          const img = await new Promise(res=>{
            const im = new Image(); im.onload=()=>res(im); im.src=ph.src;
          });
          // fit cover
          const cellW = cell.width, cellH = cell.height;
          const cellAspect = cellW/cellH; const photoAspect=ph.aspectRatio;
          let drawW, drawH, dx, dy;
          if(photoAspect>cellAspect){ drawH = cellH; drawW = drawH*photoAspect; dx = pad + cell.x + (cellW - drawW)/2; dy = pad + cell.y; }
          else{ drawW = cellW; drawH = drawW/photoAspect; dx = pad + cell.x; dy = pad + cell.y + (cellH - drawH)/2; }
          // clip
          ctx.save(); ctx.beginPath(); ctx.rect(pad+cell.x,pad+cell.y,cellW,cellH); ctx.clip();
          ctx.drawImage(img, dx, dy, drawW, drawH); ctx.restore();
        }
        // download each page as jpeg
        const blob = await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.95));
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `photo-grid-${document.getElementById('paperSize').value}-${orientation}-page${p+1}.jpg`;
        a.click(); URL.revokeObjectURL(a.href);
      }
    }

    // ZIP download of originals using JSZip (CDN)
    async function downloadAllAsZip(){
      if(photos.length===0) return;
      const zip = new JSZip();
      const folder = zip.folder('photos');
      for(let i=0;i<photos.length;i++){
        const ph = photos[i];
        // dataURL -> binary
        const dataURL = ph.src;
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        const len = bstr.length; const u8 = new Uint8Array(len);
        for(let j=0;j<len;j++) u8[j]=bstr.charCodeAt(j);
        // ensure unique filename
        let name = ph.name || `photo-${i+1}.jpg`;
        // sanitize
        name = name.replace(/[\\\/:\*\?"<>\|]/g,'_');
        folder.file(name, u8, {binary:true});
      }
      const content = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(content);
      a.download = `photos-${Date.now()}.zip`; a.click(); URL.revokeObjectURL(a.href);
    }

    // theme toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', ()=>{
      const body = document.body;
      const isDark = body.getAttribute('data-theme')==='dark';
      body.setAttribute('data-theme', isDark? 'light':'dark');
      themeToggle.classList.toggle('on', !isDark);
    });

    // buttons
    downloadAllBtn.addEventListener('click', downloadAllAsZip);
    exportBtn.addEventListener('click', exportPages);

    // simple init
    syncPhotosPerPage(12);
    renderGrid();
  </script>
</body>
</html>
